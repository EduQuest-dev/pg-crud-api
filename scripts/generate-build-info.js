#!/usr/bin/env node

/**
 * Generates src/build-info.ts with version metadata from package.json and git.
 * Run automatically as part of `npm run build`.
 */

import { readFileSync, writeFileSync } from "node:fs";
import { execSync } from "node:child_process";
import { fileURLToPath } from "node:url";
import { dirname, join } from "node:path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const root = join(__dirname, "..");

const pkg = JSON.parse(readFileSync(join(root, "package.json"), "utf-8"));
const version = pkg.version;

let gitHash = "unknown";
try {
  gitHash = execSync("git rev-parse --short HEAD", { cwd: root, encoding: "utf-8" }).trim();
} catch {
  // Not a git repo or git not available — leave as "unknown"
}

const buildTimestamp = new Date().toISOString();

const content = `// Auto-generated by scripts/generate-build-info.js — do not edit manually
export const BUILD_VERSION = ${JSON.stringify(version)};
export const BUILD_GIT_HASH = ${JSON.stringify(gitHash)};
export const BUILD_TIMESTAMP = ${JSON.stringify(buildTimestamp)};
`;

writeFileSync(join(root, "src", "build-info.ts"), content, "utf-8");
console.log(`✅ Generated build-info.ts — v${version}+${gitHash} (${buildTimestamp})`);
